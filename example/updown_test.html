<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>updown test</title>
  </head>
  <body>
    <div class="container">
      <h1>updown test</h1>
      <button id="start" type="button">start video</button>
      <h2>up</h2>
      <video id="local-video" autoplay="" style="width: 400px; height: 275px; border: 1px solid black;"></video>
      <h2>down</h2>
      <video id="remote-video" autoplay="" style="width: 400px; height: 275px; border: 1px solid black;"></video>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="./sora.js"></script>
    <script type="text/javascript">
var RTCPeerConnection = window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
var RTCSessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription;
navigator.getUserMedia = navigator.getUserMedia ||
                         navigator.webkitGetUserMedia ||
                         navigator.mozGetUserMedia ||
                         navigator.msGetUserMedia;
var upstreamPc, downstreamPc;
var sora = new Sora("ws://127.0.0.1:5000/signaling");

$("#start").on("click", function() {
  upstream();
  setTimeout(function() { downstream(); }, 5000)
});

function upstream() {
  console.log("########## upstream ##########");
  var onError = function(e) {
    console.warn(e);
  };
  var connection = sora.connection();

  navigator.getUserMedia({video: true}, function(stream) {
    var localVideo = document.getElementById("local-video");
    localVideo.src = window.URL.createObjectURL(stream);
    localVideo.play();
    connection.connect({"role": "upstream", "channelId": "Sora"})
              .then(function(offer) {
                console.log("====== offer ======");
                console.log(offer);
                console.log("====== offer sdp ======");
                console.log(offer.sdp);
                upstreamPc = new RTCPeerConnection({iceServers: offer.iceServers});
                upstreamPc.addStream(stream);
                upstreamPc.setRemoteDescription(new RTCSessionDescription(offer), function() {
                  upstreamPc.createAnswer(function(answer) {
                    upstreamPc.setLocalDescription(answer, function() {
                      console.log("====== answer ======");
                      console.log(answer);
                      console.log("====== answer sdp ======");
                      console.log(answer.sdp);
                      connection.answer(answer.sdp);
                      upstreamPc.onicecandidate = function(event) {
                        if (event.candidate !== null) {
                          console.log("====== candidate ======");
                          console.log(event.candidate);
                          connection.candidate(event.candidate);
                        }
                      };
                    }, onError);
                  }, onError);
                }, onError);
              });
  }, onError);
}

function downstream() {
  console.log("########## downstream ##########");
  var onError = function(error) {
    console.warn(error);
  }

  var connection = sora.connection();
  connection.connect({"role": "downstream", "channelId": "Sora"})
            .then(function(message) {
              console.log("====== offer ======");
              console.log(message);
              console.log("====== offer sdp ======");
              console.log(message.sdp);
              var config = {
                "iceServers": [{"urls": "stun:stun.l.google.com:19302"}]
              };
              downstreamPc = new RTCPeerConnection(config);
              downstreamPc.setRemoteDescription(new RTCSessionDescription(message), function() {
                downstreamPc.createAnswer(function(answer) {
                  downstreamPc.setLocalDescription(answer, function() {
                    console.log("====== answer ======");
                    console.log(answer);
                    console.log("====== answer sdp ======");
                    console.log(answer.sdp);
                    connection.answer(answer.sdp);
                    downstreamPc.onicecandidate = function(event) {
                      if (event.candidate !== null) {
                        console.log("====== candidate ======");
                        console.log(event.candidate);
                        connection.candidate(event.candidate);
                      }
                    };
                  }, onError);
                }, onError);
              }, onError);
              downstreamPc.onaddstream = function(event) {
                var remoteVideo = document.getElementById("remote-video");
                remoteVideo.src = window.URL.createObjectURL(event.stream);
                remoteVideo.play();
              };
            })
            .catch(function(error) {
              console.log(error);
            });
}
    </script>
  </body>
</html>
