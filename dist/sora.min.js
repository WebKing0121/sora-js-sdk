/*!
 * sora-js-sdk
 * WebRTC SFU Sora Javascript SDK
 * @version: 1.12.0-dev
 * @author: Shiguredo Inc.
 * @license: Apache-2.0
 */
!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define("Sora",[],n):"object"==typeof exports?exports.Sora=n():e.Sora=n()}("undefined"!=typeof self?self:this,function(){return function(e){function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}var t={};return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},n.p="",n(n.s=1)}([function(e,n,t){"use strict";function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),o=t(3),s=function(){function e(n,t,r,o,s){i(this,e),this.channelId=t,this.metadata=r,this.signalingUrl=n,this.options=o,this.constraints=null,this.debug=s,this.clientId=null,this.connectionId=null,this.remoteConnectionIds=[],this.stream=null,this.role=null,this._ws=null,this._pc=null,this._callbacks={disconnect:function(){},push:function(){},addstream:function(){},removestream:function(){},notify:function(){},log:function(){}},this.authMetadata=null}return r(e,[{key:"on",value:function(e,n){e in this._callbacks&&(this._callbacks[e]=n)}},{key:"disconnect",value:function(){var e=this;this.clientId=null,this.connectionId=null,this.authMetadata=null,this.remoteConnectionIds=[];var n=new Promise(function(n,t){return e.stream?(e.stream.getTracks().forEach(function(e){e.stop()}),e.stream=null,n()):n()}),t=new Promise(function(n,t){if(!e._ws)return n();e._ws.onclose=function(){};var i=5,r=setInterval(function(){return e._ws?3===e._ws.readyState?(e._ws=null,clearInterval(r),n()):(--i,i<0?(clearInterval(r),t("WebSocket Closing Error")):void 0):(clearInterval(r),t("WebSocket Closing Error"))},1e3);e._ws.close()}),i=new Promise(function(n,t){if((0,o.isSafari)()&&e._pc)return e._pc.oniceconnectionstatechange=null,e._pc.close(),e._pc=null,n();if(!e._pc||"closed"===e._pc.signalingState)return n();var i=5,r=setInterval(function(){return e._pc?"closed"===e._pc.signalingState?(clearInterval(r),e._pc.oniceconnectionstatechange=null,e._pc=null,n()):(--i,i<0?(clearInterval(r),t("PeerConnection Closing Error")):void 0):(clearInterval(r),t("PeerConnection Closing Error"))},1e3);e._pc.close()});return Promise.all([n,t,i])}},{key:"_signaling",value:function(e){var n=this;return this._trace("CREATE OFFER SDP",e),new Promise(function(t,i){var r=(0,o.createSignalingMessage)(e.sdp,n.role,n.channelId,n.metadata,n.options);null===n._ws&&(n._ws=new WebSocket(n.signalingUrl)),n._ws.onclose=function(e){i(e)},n._ws.onopen=function(){n._trace("SIGNALING CONNECT MESSAGE",r),n._ws.send(JSON.stringify(r))},n._ws.onmessage=function(e){var i=JSON.parse(e.data);"offer"==i.type?(n.clientId=i.client_id,n.connectionId=i.connection_id,n._ws.onclose=function(e){n.disconnect().then(function(){n._callbacks.disconnect(e)})},n._ws.onerror=null,"metadata"in i&&(n.authMetadata=i.metadata),n._trace("SIGNALING OFFER MESSAGE",i),n._trace("OFFER SDP",i.sdp),t(i)):"update"==i.type?(n._trace("UPDATE SDP",i.sdp),n._update(i)):"ping"==i.type?n._ws.send(JSON.stringify({type:"pong"})):"push"==i.type?n._callbacks.push(i):"notify"==i.type&&n._callbacks.notify(i)}})}},{key:"_createOffer",value:function(){var e={iceServers:[]};(0,o.isUnifiedChrome)()&&(e=Object.assign({},e,{sdpSemantics:"unified-plan"}));var n=new window.RTCPeerConnection(e);return(0,o.isSafari)()?(n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"}),n.createOffer().then(function(e){return n.close(),Promise.resolve(e)})):n.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then(function(e){return n.close(),Promise.resolve(e)})}},{key:"_connectPeerConnection",value:function(e){var n=this;return e.config||(e.config={}),void 0===window.RTCPeerConnection.generateCertificate?((0,o.isUnifiedChrome)()&&(e.config=Object.assign(e.config,{sdpSemantics:"unified-plan"})),this._trace("PEER CONNECTION CONFIG",e.config),this._pc=new window.RTCPeerConnection(e.config,this.constraints),this._pc.oniceconnectionstatechange=function(e){n._trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",n._pc.iceConnectionState)},Promise.resolve(e)):window.RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}).then(function(t){return e.config.certificates=[t],(0,o.isUnifiedChrome)()&&(e.config=Object.assign(e.config,{sdpSemantics:"unified-plan"})),n._trace("PEER CONNECTION CONFIG",e.config),n._pc=new window.RTCPeerConnection(e.config,n.constraints),n._pc.oniceconnectionstatechange=function(e){n._trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",n._pc.iceConnectionState)},e})}},{key:"_setRemoteDescription",value:function(e){return this._pc.setRemoteDescription(new window.RTCSessionDescription({type:"offer",sdp:e.sdp})).then(function(){return Promise.resolve(e)})}},{key:"_createAnswer",value:function(e){var n=this;if(this.options.simulcastRid&&this.stream){var t=this.stream.getVideoTracks()[0],i=this._pc.getTransceivers().find(function(e){if(0<=e.mid.indexOf("video"))return e});return i?(i.direction="sendonly",i.sender.replaceTrack(t).then(function(){return n._setSenderParameters(i,e.encodings)}).then(function(){return n._pc.createAnswer()}).then(function(e){return n._pc.setLocalDescription(e)})):Promise.reject("Simulcast Rid Error")}return this._pc.createAnswer().then(function(e){return n.options.simulcast&&(e.sdp=(0,o.replaceAnswerSdp)(e.sdp)),n._pc.setLocalDescription(e)})}},{key:"_setSenderParameters",value:function(e,n){var t=e.sender.getParameters();return n&&(t.encodings=n),e.sender.setParameters(t)}},{key:"_sendAnswer",value:function(){this._trace("ANSWER SDP",this._pc.localDescription.sdp),this._ws.send(JSON.stringify({type:"answer",sdp:this._pc.localDescription.sdp}))}},{key:"_sendUpdateAnswer",value:function(){this._trace("ANSWER SDP",this._pc.localDescription.sdp),this._ws.send(JSON.stringify({type:"update",sdp:this._pc.localDescription.sdp}))}},{key:"_onIceCandidate",value:function(){var e=this;return new Promise(function(n,t){var i=setInterval(function(){if(null===e._pc){clearInterval(i);var r=new Error;r.message="ICECANDIDATE TIMEOUT",t(r)}else e._pc&&"connected"===e._pc.iceConnectionState&&(clearInterval(i),n())},100);e._pc.onicecandidate=function(t){if(e._trace("ONICECANDIDATE ICEGATHERINGSTATE",e._pc.iceGatheringState),null===t.candidate)clearInterval(i),n();else{var r=t.candidate.toJSON();r.type="candidate",e._trace("ONICECANDIDATE CANDIDATE MESSAGE",r),e._ws.send(JSON.stringify(r))}}})}},{key:"_update",value:function(e){return this._setRemoteDescription(e).then(this._createAnswer.bind(this)).then(this._sendUpdateAnswer.bind(this))}},{key:"_trace",value:function(e,n){this._callbacks.log(e,n),this.debug&&(0,o.trace)(this.clientId,e,n)}}]),e}();e.exports=s},function(e,n,t){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),s=t(2),c=i(s),a=t(4),u=i(a),d={connection:function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new l(e,n)},version:function(){return"1.12.0-dev"}},l=function(){function e(n){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];r(this,e),this.signalingUrl=n,this.debug=t}return o(e,[{key:"publisher",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{audio:!0,video:!0};return new c.default(this.signalingUrl,e,n,t,this.debug)}},{key:"subscriber",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{audio:!0,video:!0};return new u.default(this.signalingUrl,e,n,t,this.debug)}}]),e}();e.exports=d},function(e,n,t){"use strict";function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function r(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function o(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}var s=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),c=t(0),a=function(e){return e&&e.__esModule?e:{default:e}}(c),u=function(e){function n(){return i(this,n),r(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return o(n,e),s(n,[{key:"connect",value:function(e){return this.role="upstream",this.options&&this.options.multistream?this._multiStream(e):this._singleStream(e)}},{key:"_singleStream",value:function(e){var n=this;return this.disconnect().then(this._createOffer).then(this._signaling.bind(this)).then(this._connectPeerConnection.bind(this)).then(function(t){return n.options.simulcast&&n.options.simulcastRid||(void 0===n._pc.addStream?e.getTracks().forEach(function(t){n._pc.addTrack(t,e)}):n._pc.addStream(e)),n.stream=e,n._setRemoteDescription(t)}).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(function(){return n.stream})}},{key:"_multiStream",value:function(e){var n=this;return this.disconnect().then(this._createOffer).then(this._signaling.bind(this)).then(this._connectPeerConnection.bind(this)).then(function(t){return void 0===n._pc.addStream?e.getTracks().forEach(function(t){n._pc.addTrack(t,e)}):n._pc.addStream(e),void 0===n._pc.ontrack?n._pc.onaddstream=function(t){n.connectionId!==t.stream.id&&(n.remoteConnectionIds.push(e.id),n._callbacks.addstream(t))}:n._pc.ontrack=function(e){var t=e.streams[0];t&&"default"!==t.id&&t.id!==n.connectionId&&(-1<n.remoteConnectionIds.indexOf(t.id)||(e.stream=t,n.remoteConnectionIds.push(t.id),n._callbacks.addstream(e)))},n._pc.onremovestream=function(e){var t=n.remoteConnectionIds.indexOf(e.stream.id);-1<t&&delete n.remoteConnectionIds[t],n._callbacks.removestream(e)},n.stream=e,n._setRemoteDescription(t)}).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(function(){return n.stream})}}]),n}(a.default);e.exports=u},function(e,n,t){"use strict";function i(e,n,t){var i="";window.performance&&(i="["+(window.performance.now()/1e3).toFixed(3)+"]"),e&&(i=i+"["+e+"]"),u()?console.log(i+" "+n+"\n",t):console.info(i+" "+n+"\n",t)}function r(){var e=window.navigator.userAgent.toLocaleLowerCase();return-1!==e.indexOf("edge")?"edge":-1!==e.indexOf("chrome")&&-1===e.indexOf("edge")?"chrome":-1!==e.indexOf("safari")&&-1===e.indexOf("chrome")?"safari":-1!==e.indexOf("opera")?"opera":-1!==e.indexOf("firefox")?"firefox":void 0}function o(){return"chrome"===r()||"safari"===r()}function s(e,n){if("VP9"===n.codec_type)return!1;if("upstream"===e&&"firefox"===r())return!1;if("safari"===r()){var t=window.navigator.appVersion.toLowerCase(),i=/version\/([\d.]+)/.exec(t).pop();return 12<parseFloat(i)||12==parseFloat(i)&&"downstream"===e&&"H264"===n.codec_type}return!0}function c(){if("chrome"!==r())return!1;var e=window.navigator.userAgent.toLocaleLowerCase(),n=/chrome\/([\d.]+)/.exec(e);return!(!n||n.length<2)&&71<=parseInt(n[1])}function a(e){return"safari"===r()&&e.includes("a=group:BUNDLE 0 1")}function u(){return"edge"===r()}function d(){return"safari"===r()}function l(){return"chrome"===r()}function f(e){var n=new RegExp(/m=video[\s\S]*?(a=ssrc:(\d+)\scname:.+\r\n(a=ssrc:\2\smsid:.+\r\na=ssrc:\2\smslabel:.+\r\na=ssrc:\2\slabel:.+\r\n)?)/),t=e.match(n);if(!t)return e;var i=t[1];n=t[1];for(var r=parseInt(t[2]),o=new RegExp(r.toString(),"g"),s=["a=ssrc-group:SIM"],c=[],a=0;a<3;a+=1)s.push((r+a).toString()),c.push(i.replace(o,(r+a).toString()));return e.replace(n,[s.join(" "),"\r\n",c.join("")].join(""))}function h(e,n,t,i,r){var u={type:"connect",role:n,channel_id:t,metadata:i,sdp:e,userAgent:window.navigator.userAgent,audio:!0,video:!0};if(Object.keys(u).forEach(function(e){void 0===u[e]&&(u[e]=null)}),"multistream"in r&&!0===r.multistream)u.multistream=!0,c()||a(e)||!o()||(u.plan_b=!0),"spotlight"in r&&(u.spotlight=r.spotlight);else if("simulcast"in r||"simulcastQuality"in r){"simulcast"in r&&!0===r.simulcast&&(u.simulcast=!0,"simulcastRid"in r&&!0===r.simulcastRid&&(u.simulcast_rid=!0));var d=["low","middle","high"];"simulcastQuality"in r&&0<=d.indexOf(r.simulcastQuality)&&(u.simulcast={quality:r.simulcastQuality})}"clientId"in r&&r.clientId&&(u.client_id=r.clientId);var l=["audioCodecType","audioBitRate"],f=["videoCodecType","videoBitRate"],h=Object.assign({},r);Object.keys(h).forEach(function(e){"audio"===e&&"boolean"==typeof h[e]||"video"===e&&"boolean"==typeof h[e]||0<=l.indexOf(e)&&null!==h[e]||0<=f.indexOf(e)&&null!==h[e]||delete h[e]}),"audio"in h&&(u.audio=h.audio);var p=Object.keys(h).some(function(e){return 0<=l.indexOf(e)});u.audio&&p&&(u.audio={},"audioCodecType"in h&&(u.audio.codec_type=h.audioCodecType),"audioBitRate"in h&&(u.audio.bit_rate=h.audioBitRate)),"video"in h&&(u.video=h.video);var m=Object.keys(h).some(function(e){return 0<=f.indexOf(e)});if(u.video&&m&&(u.video={},"videoCodecType"in h&&(u.video.codec_type=h.videoCodecType),"videoBitRate"in h&&(u.video.bit_rate=h.videoBitRate)),u.simulcast&&!s(u.role,u.video))throw new Error("Simulcast can not be used with this browser");if(u.simulcast&&u.simulcastRid&&!s(u.role,u.video))throw new Error("Simulcast Rid can not be used with this browser");return u}Object.defineProperty(n,"__esModule",{value:!0}),n.trace=i,n.isUnifiedChrome=c,n.isUnifiedSafari=a,n.isEdge=u,n.isSafari=d,n.isChrome=l,n.replaceAnswerSdp=f,n.createSignalingMessage=h},function(e,n,t){"use strict";function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function r(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function o(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}var s=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),c=t(0),a=function(e){return e&&e.__esModule?e:{default:e}}(c),u=function(e){function n(){return i(this,n),r(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return o(n,e),s(n,[{key:"connect",value:function(){return this.role="downstream",this.options&&this.options.multistream?this._multiStream():this._singleStream()}},{key:"_singleStream",value:function(){var e=this;return this.disconnect().then(this._createOffer).then(this._signaling.bind(this)).then(this._connectPeerConnection.bind(this)).then(function(n){return void 0===e._pc.ontrack?e._pc.onaddstream=function(e){this.stream=e.stream,this.remoteConnectionIds.push(this.stream.id),this._callbacks.addstream(e)}.bind(e):e._pc.ontrack=function(e){this.stream=e.streams[0];var n=this.stream.id;"default"!==n&&(-1<this.remoteConnectionIds.indexOf(n)||(e.stream=this.stream,this.remoteConnectionIds.push(n),this._callbacks.addstream(e)))}.bind(e),e._setRemoteDescription(n)}).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(function(){return e.stream})}},{key:"_multiStream",value:function(){var e=this;return this.disconnect().then(this._createOffer).then(this._signaling.bind(this)).then(this._connectPeerConnection.bind(this)).then(function(n){return void 0===e._pc.ontrack?e._pc.onaddstream=function(n){e.remoteConnectionIds.push(n.id),e._callbacks.addstream(n)}:e._pc.ontrack=function(n){var t=n.streams[0];"default"!==t.id&&t.id!==e.connectionId&&(-1<e.remoteConnectionIds.indexOf(t.id)||(n.stream=t,e.remoteConnectionIds.push(t.id),e._callbacks.addstream(n)))},e._pc.onremovestream=function(n){var t=e.remoteConnectionIds.indexOf(n.stream.id);-1<t&&delete e.remoteConnectionIds[t],e._callbacks.removestream(n)},e._setRemoteDescription(n)}).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this))}}]),n}(a.default);e.exports=u}])});