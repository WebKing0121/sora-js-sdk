/*!
 * sora-js-sdk
 * WebRTC SFU Sora Signaling Library
 * @version: 1.1.0
 * @author: Shiguredo Inc.
 * @license: Apache License 2.0
 */
!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define("Sora",[],n):"object"==typeof exports?exports.Sora=n():e.Sora=n()}(this,function(){return function(e){function n(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}var t={};return n.m=e,n.c=t,n.i=function(e){return e},n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:i})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},n.p="",n(n.s=3)}([function(e,n,t){"use strict";function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),r=t(4),c=window.RTCPeerConnection,s=window.RTCSessionDescription,a=function(){function e(n,t,o,r,c){i(this,e),this.channelId=t,this.metadata=o,this.signalingUrl=n,this.options=r,this.debug=c,this.clientId=null,this.stream=null,this.role=null,this._ws=null,this._pc=null,this._callbacks={disconnect:function(){},push:function(){},snapshot:function(){},addstream:function(){},removestream:function(){}}}return o(e,[{key:"on",value:function(e,n){e in this._callbacks&&(this._callbacks[e]=n)}},{key:"disconnect",value:function(){var e=this;this.clientId=null;var n=new Promise(function(n,t){return e.stream?(e.stream.getTracks().forEach(function(e){e.stop()}),e.stream=null,n()):n()}),t=new Promise(function(n,t){if(!e._ws)return n();e._ws.onclose=function(){};var i=5,o=setInterval(function(){return 3===e._ws.readyState?(e._ws=null,clearInterval(o),n()):(--i,i<0?(clearInterval(o),t("WebSocket Closing Error")):void 0)},1e3);e._ws.close()}),i=new Promise(function(n,t){if(!e._pc||"closed"===e._pc.signalingState)return n();var i=5,o=setInterval(function(){return"closed"===e._pc.signalingState?(clearInterval(o),e._pc=null,n()):(--i,i<0?(clearInterval(o),t("PeerConnection Closing Error")):void 0)},1e3);e._pc.close()});return Promise.all([n,t,i])}},{key:"_signaling",value:function(){var e=this;return new Promise(function(n,t){null===e._ws&&(e._ws=new WebSocket(e.signalingUrl)),e._ws.onclose=function(e){t(e)},e._ws.onerror=function(e){t(e)},e._ws.onopen=function(){var n=(0,r.createSignalingMessage)(e.role,e.channelId,e.metadata,e.options);e._trace("SIGNALING CONNECT MESSAGE",n),e._ws.send(JSON.stringify(n))},e._ws.onmessage=function(t){var i=JSON.parse(t.data);"offer"==i.type?(e.clientId=i.client_id,e._ws.onclose=function(n){e.disconnect().then(function(){e._callbacks.disconnect(n)})},e._ws.onerror=null,e._trace("SIGNALING OFFER MESSAGE",i),e._trace("OFFER SDP",i.sdp),n(i)):"update"==i.type?(e._trace("UPDATE SDP",i.sdp),e._update(i)):"ping"==i.type?e._ws.send(JSON.stringify({type:"pong"})):"push"==i.type?e._callbacks.push(i):"snapshot"==i.type&&e._callbacks.snapshot(i)}})}},{key:"_connectPeerConnection",value:function(e){var n=this;return void 0===c.generateCertificate?(this._trace("PEER CONNECTION CONFIG",e.config),this._pc=new c(e.config),this._pc.oniceconnectionstatechange=function(e){n._trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",n._pc.iceConnectionState)},Promise.resolve(e)):c.generateCertificate({name:"ECDSA",namedCurve:"P-256"}).then(function(t){return e.config.certificates=[t],n._trace("PEER CONNECTION CONFIG",e.config),n._pc=new c(e.config,{}),n._pc.oniceconnectionstatechange=function(e){n._trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",n._pc.iceConnectionState)},e})}},{key:"_setRemoteDescription",value:function(e){var n=this;return(0,r.isEdge)()?new Promise(function(t,i){n._pc.setRemoteDescription(new s({type:"offer",sdp:e.sdp}),function(){t()},function(e){i(e)})}):this._pc.setRemoteDescription(new s({type:"offer",sdp:e.sdp}))}},{key:"_createAnswer",value:function(){var e=this;return(0,r.isEdge)()?new Promise(function(n,t){e._pc.createAnswer(function(i){e._pc.setLocalDescription(i,function(){n()},function(e){t(e)})},function(e){t(e)})}):this._pc.createAnswer({}).then(function(n){return e._pc.setLocalDescription(n)})}},{key:"_sendAnswer",value:function(){this._trace("ANSWER SDP",this._pc.localDescription.sdp),this._ws.send(JSON.stringify({type:"answer",sdp:this._pc.localDescription.sdp}))}},{key:"_sendUpdateAnswer",value:function(){this._trace("ANSWER SDP",this._pc.localDescription.sdp),this._ws.send(JSON.stringify({type:"update",sdp:this._pc.localDescription.sdp}))}},{key:"_onIceCandidate",value:function(){var e=this;return new Promise(function(n,t){e._pc.onicecandidate=function(t){if(e._trace("ONICECANDIDATE ICEGATHERINGSTATE",e._pc.iceGatheringState),null===t.candidate)n();else{var i=t.candidate.toJSON();i.type="candidate",e._trace("ONICECANDIDATE CANDIDATE MESSAGE",i),e._ws.send(JSON.stringify(i))}}})}},{key:"_update",value:function(e){return this._setRemoteDescription(e).then(this._createAnswer.bind(this)).then(this._sendUpdateAnswer.bind(this))}},{key:"_trace",value:function(e,n){this.debug&&(0,r.trace)(this.clientId,e,n)}}]),e}();e.exports=a},function(e,n,t){"use strict";function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function o(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function r(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}var c=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),s=t(0),a=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(e){function n(){return i(this,n),o(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return r(n,e),c(n,[{key:"connect",value:function(e){return this.role="upstream",this.options&&this.options.multistream?this._multiStream(e):this._singleStream(e)}},{key:"_singleStream",value:function(e){var n=this;return this.disconnect().then(this._signaling.bind(this)).then(function(e){return e.config||(e.config={iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),n._connectPeerConnection(e)}).then(function(t){return n._pc.addStream(e),n.stream=e,n._setRemoteDescription(t)}).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(function(){return n.stream})}},{key:"_multiStream",value:function(e){var n=this;return this.disconnect().then(this._signaling.bind(this)).then(function(e){return e.config||(e.config={iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),n._connectPeerConnection(e)}).then(function(t){return n._pc.addStream(e),void 0===n._pc.ontrack?n._pc.onaddstream=function(e){n.clientId!==e.stream.id&&n._callbacks.addstream(e)}:n._pc.ontrack=function(e){var t=e.streams[0];"default"!==t.id&&"video"===e.track.kind&&(e.stream=t,n._callbacks.addstream(e))},n._pc.onremovestream=function(e){n._callbacks.removestream(e)},n.stream=e,n._setRemoteDescription(t)}).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(function(){return n.stream})}}]),n}(a.default);e.exports=u},function(e,n,t){"use strict";function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function o(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function r(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}var c=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),s=t(0),a=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(e){function n(){return i(this,n),o(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return r(n,e),c(n,[{key:"connect",value:function(){return this.role="downstream",this.options&&this.options.multistream?this._multiStream():this._singleStream()}},{key:"_singleStream",value:function(){var e=this;return this.disconnect().then(this._signaling.bind(this)).then(function(n){return n.config||(n.config={iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),e._connectPeerConnection(n)}).then(function(n){return e._pc.onaddstream=function(e){this.stream=e.stream}.bind(e),e._setRemoteDescription(n)}).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(function(){return e.stream})}},{key:"_multiStream",value:function(){var e=this;return this.disconnect().then(this._signaling.bind(this)).then(function(n){return n.config||(n.config={iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),e._connectPeerConnection(n)}).then(function(n){return void 0===e._pc.ontrack?e._pc.onaddstream=function(n){e._callbacks.addstream(n)}:e._pc.ontrack=function(n){var t=n.streams[0];"default"!==t.id&&"video"===n.track.kind&&(n.stream=t,e._callbacks.addstream(n))},e._pc.onremovestream=function(n){e._callbacks.removestream(n)},e._setRemoteDescription(n)}).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this))}}]),n}(a.default);e.exports=u},function(e,n,t){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),c=t(1),s=i(c),a=t(2),u=i(a),l={connection:function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new f(e,n)}},f=function(){function e(n){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];o(this,e),this.signalingUrl=n,this.debug=t}return r(e,[{key:"publisher",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{audio:!0,video:!0};return new s.default(this.signalingUrl,e,n,t,this.debug)}},{key:"subscriber",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{audio:!0,video:!0};return new u.default(this.signalingUrl,e,n,t,this.debug)}}]),e}();e.exports=l},function(e,n,t){"use strict";function i(e,n,t){var i="";window.performance&&(i="["+(window.performance.now()/1e3).toFixed(3)+"]"),e&&(i=i+"["+e+"]"),c()?console.log(i+" "+n+"\n",t):console.info(i+" "+n+"\n",t)}function o(){return window.navigator.userAgent.toLocaleLowerCase()}function r(){return-1!==o().indexOf("chrome")}function c(){return-1!==o().indexOf("edge")}function s(e,n,t,i){var o={type:"connect",role:e,channel_id:n,access_token:t};Object.keys(o).forEach(function(e){void 0===o[e]&&(o[e]=null)}),"multistream"in i&&!0===i.multistream&&(o.multistream=!0,o.plan_b=r());var c=!0;"audio"in i&&"boolean"==typeof i.audio&&(c=i.audio),c&&"audioCodecType"in i&&(c={codec_type:i.audioCodecType}),o.audio=c;var s=!0;if("video"in i&&(s=i.video),s){var a=["videoCodecType","videoBitRate","videoSnapshot"];Object.keys(i).some(function(e){return 0<=a.indexOf(e)})&&(s={},"videoCodecType"in i&&(s.codec_type=i.videoCodecType),"videoBitRate"in i&&(s.bit_rate=i.videoBitRate),"videoSnapshot"in i&&(s.snapshot=i.videoSnapshot))}return o.video=s,o}Object.defineProperty(n,"__esModule",{value:!0}),n.trace=i,n.isEdge=c,n.createSignalingMessage=s}])});