/*!
 * sora-js-sdk
 * WebRTC SFU Sora Signaling Library
 * @version: 0.5.0
 * @author: Shiguredo Inc.
 * @license: Apache License 2.0
 */
var Sora=function(e){function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}var t={};return n.m=e,n.c=t,n.i=function(e){return e},n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},n.p="",n(n.s=4)}([function(e,n,t){"use strict";function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),i=t(3),c=window.RTCPeerConnection,s=window.RTCSessionDescription,u=function(){function e(n,t,r,i,c){o(this,e),this.channelId=t,this.metadata=r,this.signalingUrl=n,this.options=i,this.debug=c,this.clientId=null,this.stream=null,this.role=null,this._ws=null,this._pc=null,this._callbacks={disconnect:function(){},notify:function(){}}}return r(e,[{key:"on",value:function(e,n){e in this._callbacks&&(this._callbacks[e]=n)}},{key:"disconnect",value:function(){var e=this;return this.clientId=null,new Promise(function(n,t){try{e.stream&&(e.stream.getTracks().forEach(function(e){e.stop()}),e.stream=null)}catch(n){e.stream=null}return n()}).then(function(){try{e._ws&&(e._ws.onclose=function(){return e._ws=null,Promise.resolve()},e._ws.close())}catch(n){return e._ws=null,Promise.resolve()}}).then(function(){try{e._pc&&"closed"!==e._pc.signalingState&&e._pc.close();var n=setInterval(function(){if(e._pc&&"closed"===e._pc.signalingState)return clearInterval(n),e._pc=null,Promise.resolve();clearInterval(n)},1e3)}catch(n){return e._pc=null,Promise.resolve()}})}},{key:"_signaling",value:function(){var e=this;return new Promise(function(n,t){null===e._ws&&(e._ws=new WebSocket(e.signalingUrl)),e._ws.onclose=function(e){t(e)},e._ws.onerror=function(e){t(e)},e._ws.onopen=function(){var n=(0,i.createSignalingMessage)(e.role,e.channelId,e.metadata,e.options);e._ws.send(JSON.stringify(n))},e._ws.onmessage=function(t){var o=JSON.parse(t.data);"offer"==o.type?(e.clientId=o.client_id,e._ws.onclose=function(n){e.disconnect().then(function(){e._callbacks.disconnect(n)})},e._ws.onerror=null,n(o)):"ping"==o.type?e._ws.send(JSON.stringify({type:"pong"})):"notify"==o.type&&e._callbacks.notify(o)}})}},{key:"_connectPeerConnection",value:function(e){var n=this;return c.generateCertificate({name:"ECDSA",namedCurve:"P-256"}).then(function(t){return e.config.certificates=[t],n._pc=new c(e.config,{}),n._pc.oniceconnectionstatechange=function(e){},e})}},{key:"_setRemoteDescription",value:function(e){return this._pc.setRemoteDescription(new s({type:"offer",sdp:e.sdp}))}},{key:"_createAnswer",value:function(){var e=this;return this._pc.createAnswer({}).then(function(n){return e._pc.setLocalDescription(n)}).then(function(){e._ws.send(JSON.stringify({type:"answer",sdp:e._pc.localDescription.sdp}))})}},{key:"_onIceCandidate",value:function(){var e=this;return new Promise(function(n,t){e._pc.onicecandidate=function(t){if(null===t.candidate)n();else{var o=t.candidate.toJSON();o.type="candidate",e._ws.send(JSON.stringify(o))}}})}}]),e}();e.exports=u},function(e,n,t){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function c(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}var s=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),u=t(0),a=o(u),l=function(e){function n(){return r(this,n),i(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return c(n,e),s(n,[{key:"connect",value:function(e){var n=this;return this.role="upstream",this.disconnect().then(this._signaling.bind(this)).then(function(e){return e.config||(e.config={iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),n._connectPeerConnection(e)}).then(function(t){return n._pc.addStream(e),n.stream=e,n._setRemoteDescription(t)}).then(this._createAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(function(){return n.stream})}}]),n}(a.default);e.exports=l},function(e,n,t){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function c(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}var s=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),u=t(0),a=o(u),l=function(e){function n(){return r(this,n),i(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return c(n,e),s(n,[{key:"connect",value:function(){var e=this;return this.role="downstream",this.disconnect().then(this._signaling.bind(this)).then(function(n){return n.config||(n.config={iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),e._connectPeerConnection(n)}).then(function(n){return e._pc.onaddstream=function(e){this.stream=e.stream}.bind(e),e._setRemoteDescription(n)}).then(this._createAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(function(){return e.stream})}}]),n}(a.default);e.exports=l},function(e,n,t){"use strict";function o(){return window.navigator.userAgent.toLocaleLowerCase().indexOf("chrome")!=-1}function r(e,n,t,r){var i={type:"connect",role:e,channel_id:n,access_token:t};Object.keys(i).forEach(function(e){void 0===i[e]&&(i[e]=null)}),"multistream"in r&&r.multistream===!0&&(i.multistream=!0,i.plan_b=o());var c=!0;"audio"in r&&"boolean"==typeof r.audio&&(c=r.audio),c&&"audioCodecType"in r&&(c={codec_type:r.audioCodecType}),i.audio=c;var s=!0;if("video"in r&&(s=r.video),s){var u=["videoCodecType","videoBitRate","videoSnapshot"];Object.keys(r).some(function(e){return 0<=u.indexOf(e)})&&(s={},"videoCodecType"in r&&(s.codec_type=r.videoCodecType),"videoBitRate"in r&&(s.bit_rate=r.videoBitRate),"videoSnapshot"in r&&(s.snapshot=r.videoSnapshot))}return i.video=s,i}Object.defineProperty(n,"__esModule",{value:!0}),n.createSignalingMessage=r},function(e,n,t){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),c=t(1),s=o(c),u=t(2),a=o(u),l={connection:function(e){return new f(e,arguments.length>1&&void 0!==arguments[1]&&arguments[1])}},f=function(){function e(n){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];r(this,e),this.signalingUrl=n,this.debug=t}return i(e,[{key:"publisher",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{audio:!0,video:!0};return new s.default(this.signalingUrl,e,n,t,this.debug)}},{key:"subscriber",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{audio:!0,video:!0};return new a.default(this.signalingUrl,e,n,t,this.debug)}}]),e}();e.exports=l}]);