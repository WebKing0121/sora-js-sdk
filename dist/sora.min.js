/*!
 * sora-js-sdk
 * WebRTC SFU Sora Signaling Library
 * @version: 1.7.4
 * @author: Shiguredo Inc.
 * @license: Apache-2.0
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("Sora",[],t):"object"==typeof exports?exports.Sora=t():e.Sora=t()}(this,function(){return function(e){function t(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=1)}([function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=n(3),c=window.RTCPeerConnection,a=window.RTCSessionDescription,s=function(){function e(t,n,r,o,c){i(this,e),this.channelId=n,this.metadata=r,this.signalingUrl=t,this.options=o,this.constraints=null,this.debug=c,this.clientId=null,this.remoteClientIds=[],this.stream=null,this.role=null,this._ws=null,this._pc=null,this._callbacks={disconnect:function(){},push:function(){},snapshot:function(){},addstream:function(){},removestream:function(){},notify:function(){},log:function(){}}}return r(e,[{key:"on",value:function(e,t){e in this._callbacks&&(this._callbacks[e]=t)}},{key:"disconnect",value:function(){var e=this;this.clientId=null;var t=new Promise(function(t,n){return e.stream?(e.stream.getTracks().forEach(function(e){e.stop()}),e.stream=null,t()):t()}),n=new Promise(function(t,n){if(!e._ws)return t();e._ws.onclose=function(){};var i=5,r=setInterval(function(){return e._ws?3===e._ws.readyState?(e._ws=null,clearInterval(r),t()):(--i,i<0?(clearInterval(r),n("WebSocket Closing Error")):void 0):(clearInterval(r),n("WebSocket Closing Error"))},1e3);e._ws.close()}),i=new Promise(function(t,n){if(!e._pc||"closed"===e._pc.signalingState)return t();var i=5,r=setInterval(function(){return e._pc?"closed"===e._pc.signalingState?(clearInterval(r),e._pc=null,t()):(--i,i<0?(clearInterval(r),n("PeerConnection Closing Error")):void 0):(clearInterval(r),n("PeerConnection Closing Error"))},1e3);e._pc.close()});return Promise.all([t,n,i])}},{key:"_signaling",value:function(e){var t=this;return this._trace("CREATE OFFER SDP",e),new Promise(function(n,i){null===t._ws&&(t._ws=new WebSocket(t.signalingUrl)),t._ws.onclose=function(e){i(e)},t._ws.onopen=function(){var n=(0,o.createSignalingMessage)(e.sdp,t.role,t.channelId,t.metadata,t.options);t._trace("SIGNALING CONNECT MESSAGE",n),t._ws.send(JSON.stringify(n))},t._ws.onmessage=function(e){var i=JSON.parse(e.data);"offer"==i.type?(t.clientId=i.client_id,t._ws.onclose=function(e){t.disconnect().then(function(){t._callbacks.disconnect(e)})},t._ws.onerror=null,t._trace("SIGNALING OFFER MESSAGE",i),t._trace("OFFER SDP",i.sdp),n(i)):"update"==i.type?(t._trace("UPDATE SDP",i.sdp),t._update(i)):"ping"==i.type?t._ws.send(JSON.stringify({type:"pong"})):"push"==i.type?t._callbacks.push(i):"snapshot"==i.type?t._callbacks.snapshot(i):"notify"==i.type&&t._callbacks.notify(i)}})}},{key:"_createOffer",value:function(){var e=new c({iceServers:[]});return void 0===e.addTransceiver?e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}):(e.addTransceiver("video").setDirection("recvonly"),e.addTransceiver("audio").setDirection("recvonly"),e.createOffer())}},{key:"_connectPeerConnection",value:function(e){var t=this;return e.config||(e.config={}),void 0===c.generateCertificate?(this._trace("PEER CONNECTION CONFIG",e.config),this._pc=new c(e.config,this.constraints),this._pc.oniceconnectionstatechange=function(e){t._trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",t._pc.iceConnectionState)},Promise.resolve(e)):c.generateCertificate({name:"ECDSA",namedCurve:"P-256"}).then(function(n){return e.config.certificates=[n],t._trace("PEER CONNECTION CONFIG",e.config),t._pc=new c(e.config,t.constraints),t._pc.oniceconnectionstatechange=function(e){t._trace("ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE",t._pc.iceConnectionState)},e})}},{key:"_setRemoteDescription",value:function(e){return this._pc.setRemoteDescription(new a({type:"offer",sdp:e.sdp}))}},{key:"_createAnswer",value:function(){var e=this;return this._pc.createAnswer().then(function(t){return e._pc.setLocalDescription(t)})}},{key:"_sendAnswer",value:function(){this._trace("ANSWER SDP",this._pc.localDescription.sdp),this._ws.send(JSON.stringify({type:"answer",sdp:this._pc.localDescription.sdp}))}},{key:"_sendUpdateAnswer",value:function(){this._trace("ANSWER SDP",this._pc.localDescription.sdp),this._ws.send(JSON.stringify({type:"update",sdp:this._pc.localDescription.sdp}))}},{key:"_onIceCandidate",value:function(){var e=this;return new Promise(function(t,n){var i=setInterval(function(){e._pc.iceConnectionState&&(clearInterval(i),t())},100);e._pc.onicecandidate=function(n){if(e._trace("ONICECANDIDATE ICEGATHERINGSTATE",e._pc.iceGatheringState),null===n.candidate)clearInterval(i),t();else{var r=n.candidate.toJSON();r.type="candidate",e._trace("ONICECANDIDATE CANDIDATE MESSAGE",r),e._ws.send(JSON.stringify(r))}}})}},{key:"_update",value:function(e){return this._setRemoteDescription(e).then(this._createAnswer.bind(this)).then(this._sendUpdateAnswer.bind(this))}},{key:"_trace",value:function(e,t){this._callbacks.log(e,t),this.debug&&(0,o.trace)(this.clientId,e,t)}}]),e}();e.exports=s},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),c=n(2),a=i(c),s=n(4),u=i(s),l={connection:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new d(e,t)}},d=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];r(this,e),this.signalingUrl=t,this.debug=n}return o(e,[{key:"publisher",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{audio:!0,video:!0};return new a.default(this.signalingUrl,e,t,n,this.debug)}},{key:"subscriber",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{audio:!0,video:!0};return new u.default(this.signalingUrl,e,t,n,this.debug)}}]),e}();e.exports=l},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var c=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),a=n(0),s=function(e){return e&&e.__esModule?e:{default:e}}(a),u=function(e){function t(){return i(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return o(t,e),c(t,[{key:"connect",value:function(e){return this.role="upstream",this.options&&this.options.multistream?this._multiStream(e):this._singleStream(e)}},{key:"_singleStream",value:function(e){var t=this;return this.disconnect().then(this._createOffer).then(this._signaling.bind(this)).then(function(e){return t._connectPeerConnection(e)}).then(function(n){return void 0===t._pc.addStream?e.getTracks().forEach(function(n){t._pc.addTrack(n,e)}):t._pc.addStream(e),t.stream=e,t._setRemoteDescription(n)}).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(function(){return t.stream})}},{key:"_multiStream",value:function(e){var t=this;return this.disconnect().then(this._createOffer).then(this._signaling.bind(this)).then(function(e){return t._connectPeerConnection(e)}).then(function(n){return void 0===t._pc.addStream?e.getTracks().forEach(function(n){t._pc.addTrack(n,e)}):t._pc.addStream(e),void 0===t._pc.ontrack?t._pc.onaddstream=function(n){t.clientId!==n.stream.id&&(t.remoteClientIds.push(e.id),t._callbacks.addstream(n))}:t._pc.ontrack=function(e){var n=e.streams[0];"default"!==n.id&&n.id!==t.clientId&&(-1<t.remoteClientIds.indexOf(n.id)||(e.stream=n,t.remoteClientIds.push(n.id),t._callbacks.addstream(e)))},t._pc.onremovestream=function(e){var n=t.remoteClientIds.indexOf(e.stream.id);-1<n&&delete t.remoteClientIds[n],t._callbacks.removestream(e)},t.stream=e,t._setRemoteDescription(n)}).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(function(){return t.stream})}}]),t}(s.default);e.exports=u},function(e,t,n){"use strict";function i(e,t,n){var i="";window.performance&&(i="["+(window.performance.now()/1e3).toFixed(3)+"]"),e&&(i=i+"["+e+"]"),c()?console.log(i+" "+t+"\n",n):console.info(i+" "+t+"\n",n)}function r(){return window.navigator.userAgent.toLocaleLowerCase()}function o(){return-1!==r().indexOf("chrome")||-1!==r().indexOf("safari")}function c(){return-1!==r().indexOf("edge")}function a(e,t,n,i,r){var c={type:"connect",role:t,channel_id:n,metadata:i,sdp:e,userAgent:window.navigator.userAgent,audio:!0,video:!0};Object.keys(c).forEach(function(e){void 0===c[e]&&(c[e]=null)}),"multistream"in r&&!0===r.multistream&&(c.multistream=!0,c.plan_b=o());var a=["audioCodecType","audioBitRate"],s=["videoCodecType","videoBitRate","videoSnapshot"],u=Object.assign({},r);Object.keys(u).forEach(function(e){"audio"===e&&"boolean"==typeof u[e]||"video"===e&&"boolean"==typeof u[e]||0<=a.indexOf(e)&&null!==u[e]||0<=s.indexOf(e)&&null!==u[e]||delete u[e]}),"audio"in u&&(c.audio=u.audio);var l=Object.keys(u).some(function(e){return 0<=a.indexOf(e)});c.audio&&l&&(c.audio={},"audioCodecType"in u&&(c.audio.codec_type=u.audioCodecType),"audioBitRate"in u&&(c.audio.bit_rate=u.audioBitRate)),"video"in u&&(c.video=u.video);var d=Object.keys(u).some(function(e){return 0<=s.indexOf(e)});return c.video&&d&&(c.video={},"videoCodecType"in u&&(c.video.codec_type=u.videoCodecType),"videoBitRate"in u&&(c.video.bit_rate=u.videoBitRate),"videoSnapshot"in u&&(c.video.snapshot=u.videoSnapshot)),c}Object.defineProperty(t,"__esModule",{value:!0}),t.trace=i,t.isEdge=c,t.createSignalingMessage=a},function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var c=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),a=n(0),s=function(e){return e&&e.__esModule?e:{default:e}}(a),u=function(e){function t(){return i(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return o(t,e),c(t,[{key:"connect",value:function(){return this.role="downstream",this.options&&this.options.multistream?this._multiStream():this._singleStream()}},{key:"_singleStream",value:function(){var e=this;return this.disconnect().then(this._createOffer).then(this._signaling.bind(this)).then(function(t){return e._connectPeerConnection(t)}).then(function(t){return void 0===e._pc.ontrack?e._pc.onaddstream=function(e){this.stream=e.stream}.bind(e):e._pc.ontrack=function(e){this.stream=e.streams[0]}.bind(e),e._setRemoteDescription(t)}).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this)).then(function(){return e.stream})}},{key:"_multiStream",value:function(){var e=this;return this.disconnect().then(this._createOffer).then(this._signaling.bind(this)).then(function(t){return e._connectPeerConnection(t)}).then(function(t){return void 0===e._pc.ontrack?e._pc.onaddstream=function(t){e._callbacks.addstream(t)}:e._pc.ontrack=function(t){var n=t.streams[0];"default"!==n.id&&n.id!==e.clientId&&"video"===t.track.kind&&(t.stream=n,e._callbacks.addstream(t))},e._pc.onremovestream=function(t){e._callbacks.removestream(t)},e._setRemoteDescription(t)}).then(this._createAnswer.bind(this)).then(this._sendAnswer.bind(this)).then(this._onIceCandidate.bind(this))}}]),t}(s.default);e.exports=u}])});